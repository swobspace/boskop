require 'rails_helper'

RSpec.describe "vulnerability_details/index", type: :view do
  before(:each) do
    @ability = Object.new
    @ability.extend(CanCan::Ability)
    allow(controller).to receive(:current_ability) { @ability }
    allow(controller).to receive(:controller_name) { "vulnerability_details" }
    allow(controller).to receive(:action_name) { "index" }

    assign(:vulnerability_details, [
      VulnerabilityDetail.create!(
        :name => "Name1",
        :nvt => "Nvt1",
        :family => "Family",
        :threat => "Threat",
        :severity => "9.3",
        :cves => ["CVE-123", "CVE-456"],
        :bids => ["123", "456"],
        :xrefs => ["URL:hellothere", "URL:hithis"],
        :notes  => {"summary" => "a short summary"}.to_json,
        :certs => [ {id: "DFN-CERT-123", type: "DFN-CERT"} ].to_json
      ),
      VulnerabilityDetail.create!(
        :name => "Name2",
        :nvt => "Nvt2",
        :family => "Family",
        :threat => "Threat",
        :severity => "9.3",
        :cves => ["CVE-123", "CVE-456"],
        :bids => ["123", "456"],
        :xrefs => ["URL:hellothere", "URL:hithis"],
        :notes  => {"summary" => "a short summary"}.to_json,
        :certs => [ {id: "DFN-CERT-123", type: "DFN-CERT"} ].to_json
      )
    ])
  end

  it "renders a list of vulnerability_details" do
    render
    assert_select "tr>td", :text => "Name1".to_s, :count => 1
    assert_select "tr>td", :text => "Name2".to_s, :count => 1
    assert_select "tr>td", :text => "Nvt1".to_s, :count => 1
    assert_select "tr>td", :text => "Nvt2".to_s, :count => 1
    assert_select "tr>td", :text => "Family".to_s, :count => 2
    assert_select "tr>td", :text => "Threat".to_s, :count => 2
    assert_select "tr>td", :text => "9.3".to_s, :count => 2
    assert_select "tr>td", :text => "CVE-123, CVE-456".to_s, :count => 2
    assert_select "tr>td", :text => "123, 456".to_s, :count => 2
    assert_select "tr>td", :text => "hellothere, hithis".to_s, :count => 2
    pending "to be implemented later"
    assert_select "tr>td", :text => "summary=a short summary".to_s, :count => 2
  end
end
