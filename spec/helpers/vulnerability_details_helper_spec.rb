require "rails_helper"

RSpec.describe VulnerabilityDetailsHelper, :type => :helper do

  describe "#dl_notes" do
    let(:myhash) {{
      "summary" => "a short summary"
    }}
    subject { Capybara.string(helper.dl_notes(myhash)) }
    it { expect(subject.find("dl dt").text).to match("summary") }
    it { expect(subject.find("dl dd").text).to match("a short summary") }
  end

  describe "#link_to_xrefs" do
    let(:xrefs) {[
      "URL:https://hithis",
      "URL:http://hellothere",
      "MSFT:MS17-010",
      "MSKB:4012212",
      "EDB-ID:41987",
    ]}
    subject { Capybara.string(helper.link_to_xrefs(xrefs)) }
    it { expect(subject.all("a")[0]['href']).to match("https://hithis") }
    it { expect(subject.all("a")[1]['href']).to match("http://hellothere") }
    it { expect(subject.all("a")[2]['href']).to match("https://docs.microsoft.com/en-us/security-updates/securitybulletins/2017/MS17-010") }
    it { expect(subject.all("a")[3]['href']).to match("https://support.microsoft.com/en-us/help/4012212") }
    it { expect(subject.all("a")[4]['href']).to match("https://www.exploit-db.com/exploits/41987") }
  end

  describe "#link_to_bids" do
    let(:bids) {[ "96703","96704" ]}
    subject { Capybara.string(helper.link_to_bids(bids)) }
    it { expect(subject.all("a").first['href']).to match("http://www.securityfocus.com/bid/96703") }
    it { expect(subject.all("a").last['href']).to match("http://www.securityfocus.com/bid/96704") }
  end

  describe "#link_to_cves" do
    let(:cves) {[ "CVE-2012-0002", "CVE-2017-0143" ]}
    subject { Capybara.string(helper.link_to_cves(cves)) }
    it { expect(subject.all("a").first['href']).to match("https://www.cvedetails.com/cve/CVE-2012-0002/") }
    it { expect(subject.all("a").last['href']).to match("https://www.cvedetails.com/cve/CVE-2017-0143/") }
  end

  describe "#certs" do
    let(:certs) {[{"id"=>"CB-K17/0435", "type"=>"CERT-Bund"}, {"id"=>"DFN-CERT-2017-0448", "type"=>"DFN-CERT"}]}
    subject { helper.certs(certs) }
    it { expect(subject).to match(/CERT-Bund: CB-K17\/0435/) }
    it { expect(subject).to match(/DFN-CERT: DFN-CERT-2017-0448/) }
  end
end
