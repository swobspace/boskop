require 'rails_helper'

RSpec.describe VulnerabilityQuery do
  include_context "vulnerability variables"
  let(:vulnerabilities) { Vulnerability.left_outer_joins(
    :vulnerability_detail, host: [ :host_category, :operating_system, :location ]
  )}

  # check for class methods
  it { expect(VulnerabilityQuery.respond_to? :new).to be_truthy}

  it "raise an ArgumentError" do
  expect {
    VulnerabilityQuery.new
  }.to raise_error(ArgumentError)
  end

 # check for instance methods
  describe "instance methods" do
    subject { VulnerabilityQuery.new(vulnerabilities) }
    it { expect(subject.respond_to? :all).to be_truthy}
    it { expect(subject.respond_to? :find_each).to be_truthy}
    it { expect(subject.respond_to? :include?).to be_truthy }
  end

 context "with unknown option :fasel" do
    subject { VulnerabilityQuery.new(vulnerabilities, {fasel: 'blubb'}) }
    describe "#all" do
      it "raises a argument error" do
        expect { subject.all }.to raise_error(ArgumentError)
      end
    end
  end

  context "with :name" do
    subject { VulnerabilityQuery.new(vulnerabilities, {hostname: 'my.domain'}) }
    describe "#all" do
      it { expect(subject.all).to contain_exactly(vuln11, vuln12, vuln13, vuln22, vuln23) }
    end
    describe "#find_each" do
      it "executes matching vulns" do
        vulns = []
        subject.find_each do |vuln|
          vulns << vuln
        end
        expect(vulns).to contain_exactly(vuln11, vuln12, vuln13, vuln22, vuln23)
      end
    end
    describe "#include?" do
      it { expect(subject.include?(vuln11)).to be_truthy }
      it { expect(subject.include?(vuln12)).to be_truthy }
      it { expect(subject.include?(vuln13)).to be_truthy }
      it { expect(subject.include?(vuln22)).to be_truthy }
      it { expect(subject.include?(vuln23)).to be_truthy }
      it { expect(subject.include?(vuln33)).to be_falsey }
    end
  end # search :name

  context "with :name" do
    subject { VulnerabilityQuery.new(vulnerabilities, {name: 'Old'}) }
    describe "#all" do
      it { expect(subject.all).to contain_exactly(vuln12, vuln22, vuln13, vuln23, vuln33) }
    end
    describe "#find_each" do
      it "executes matching vulns" do
        vulns = []
        subject.find_each do |vuln|
          vulns << vuln
        end
        expect(vulns).to contain_exactly(vuln12, vuln22, vuln13, vuln23, vuln33)
      end
    end
    describe "#include?" do
      it { expect(subject.include?(vuln11)).to be_falsey }
      it { expect(subject.include?(vuln12)).to be_truthy }
      it { expect(subject.include?(vuln13)).to be_truthy }
      it { expect(subject.include?(vuln22)).to be_truthy }
      it { expect(subject.include?(vuln23)).to be_truthy }
      it { expect(subject.include?(vuln33)).to be_truthy }
    end
  end # search :name

  context "with :limit" do
    subject { VulnerabilityQuery.new(vulnerabilities, {limit: 3}) }
    describe "#all" do
      it { expect(subject.all).to contain_exactly(vuln11, vuln12, vuln13) }
    end
    describe "#find_each" do
      it "executes matching vulns" do
        vulns = []
        subject.find_each do |vuln|
          vulns << vuln
        end
        expect(vulns).to contain_exactly(vuln11, vuln12, vuln13)
      end
    end
    describe "#include?" do
      it { expect(subject.include?(vuln11)).to be_truthy }
      it { expect(subject.include?(vuln12)).to be_truthy }
      it { expect(subject.include?(vuln13)).to be_truthy }
    end
  end # search :limit

  context "with :operating_system" do
    subject { VulnerabilityQuery.new(vulnerabilities, {operating_system: 'ummyO'}) }
    describe "#all" do
      it { expect(subject.all).to contain_exactly(vuln22, vuln23) }
    end
    describe "#find_each" do
      it "executes matching vulns" do
        vulns = []
        subject.find_each do |vuln|
          vulns << vuln
        end
        expect(vulns).to contain_exactly(vuln22, vuln23)
      end
    end
    describe "#include?" do
      it { expect(subject.include?(vuln11)).to be_falsey }
      it { expect(subject.include?(vuln12)).to be_falsey }
      it { expect(subject.include?(vuln13)).to be_falsey }
      it { expect(subject.include?(vuln22)).to be_truthy }
      it { expect(subject.include?(vuln23)).to be_truthy }
      it { expect(subject.include?(vuln33)).to be_falsey }
    end
  end # search :operating_system

  context "with :host_category" do
    subject { VulnerabilityQuery.new(vulnerabilities, {host_category: 'erveR'}) }
    describe "#all" do
      it { expect(subject.all).to contain_exactly(vuln33) }
    end
    describe "#find_each" do
      it "executes matching vulns" do
        vulns = []
        subject.find_each do |vuln|
          vulns << vuln
        end
        expect(vulns).to contain_exactly(vuln33)
      end
    end
    describe "#include?" do
      it { expect(subject.include?(vuln11)).to be_falsey }
      it { expect(subject.include?(vuln12)).to be_falsey }
      it { expect(subject.include?(vuln13)).to be_falsey }
      it { expect(subject.include?(vuln22)).to be_falsey }
      it { expect(subject.include?(vuln23)).to be_falsey }
      it { expect(subject.include?(vuln33)).to be_truthy }
    end
  end # search :host_category

  context "with :threat" do
    subject { VulnerabilityQuery.new(vulnerabilities, {threat: 'High'}) }
    describe "#all" do
      it { expect(subject.all).to contain_exactly(vuln11) }
    end
    describe "#find_each" do
      it "executes matching vulns" do
        vulns = []
        subject.find_each do |vuln|
          vulns << vuln
        end
        expect(vulns).to contain_exactly(vuln11)
      end
    end
    describe "#include?" do
      it { expect(subject.include?(vuln11)).to be_truthy }
    end
  end # search :threat

  context "with :severity" do
    subject { VulnerabilityQuery.new(vulnerabilities, {severity: '6.0'}) }
    describe "#all" do
      it { expect(subject.all).to contain_exactly(vuln11, vuln12, vuln22) }
    end
    describe "#find_each" do
      it "executes matching vulns" do
        vulns = []
        subject.find_each do |vuln|
          vulns << vuln
        end
        expect(vulns).to contain_exactly(vuln11, vuln12, vuln22)
      end
    end
    describe "#include?" do
      it { expect(subject.include?(vuln11)).to be_truthy }
      it { expect(subject.include?(vuln12)).to be_truthy }
      it { expect(subject.include?(vuln13)).to be_falsey }
      it { expect(subject.include?(vuln22)).to be_truthy }
      it { expect(subject.include?(vuln23)).to be_falsey }
      it { expect(subject.include?(vuln33)).to be_falsey }
    end
  end # search :severity

  context "with :ip as string match" do
    subject { VulnerabilityQuery.new(vulnerabilities, {ip: '198.51.100'}) }
    describe "#all" do
      it { expect(subject.all).to contain_exactly(vuln11, vuln12, vuln13, vuln22, vuln23) }
    end
    describe "#find_each" do
      it "executes matching vulns" do
        vulns = []
        subject.find_each do |vuln|
          vulns << vuln
        end
        expect(vulns).to contain_exactly(vuln11, vuln12, vuln13, vuln22, vuln23)
      end
    end
    describe "#include?" do
      it { expect(subject.include?(vuln11)).to be_truthy }
      it { expect(subject.include?(vuln12)).to be_truthy }
      it { expect(subject.include?(vuln13)).to be_truthy }
      it { expect(subject.include?(vuln22)).to be_truthy }
      it { expect(subject.include?(vuln23)).to be_truthy }
      it { expect(subject.include?(vuln33)).to be_falsey }
    end
  end # search :ip string match

  context "with :ip as subnet" do
    subject { VulnerabilityQuery.new(vulnerabilities, {ip: '198.51.100.0/26'}) }
    describe "#all" do
      it { expect(subject.all).to contain_exactly(vuln11, vuln12, vuln13) }
    end
    describe "#find_each" do
      it "executes matching vulns" do
        vulns = []
        subject.find_each do |vuln|
          vulns << vuln
        end
        expect(vulns).to contain_exactly(vuln11, vuln12, vuln13)
      end
    end
    describe "#include?" do
      it { expect(subject.include?(vuln11)).to be_truthy }
      it { expect(subject.include?(vuln12)).to be_truthy }
      it { expect(subject.include?(vuln13)).to be_truthy }
      it { expect(subject.include?(vuln22)).to be_falsey }
      it { expect(subject.include?(vuln23)).to be_falsey }
      it { expect(subject.include?(vuln33)).to be_falsey }
    end
  end # search :ip subnet match

  context "with :lastseen" do
    subject { VulnerabilityQuery.new(vulnerabilities, {lastseen: '2017-04'}) }
    describe "#all" do
      it { expect(subject.all).to contain_exactly(vuln13,vuln22) }
    end
    describe "#find_each" do
      it "executes matching vulns" do
        vulns = []
        subject.find_each do |vuln|
          vulns << vuln
        end
        expect(vulns).to contain_exactly(vuln13,vuln22)
      end
    end
    describe "#include?" do
      it { expect(subject.include?(vuln11)).to be_falsey }
      it { expect(subject.include?(vuln12)).to be_falsey }
      it { expect(subject.include?(vuln13)).to be_truthy }
      it { expect(subject.include?(vuln22)).to be_truthy }
      it { expect(subject.include?(vuln23)).to be_falsey }
      it { expect(subject.include?(vuln33)).to be_falsey }
    end
  end # search :lastseen

  context "with :newer" do
    subject { VulnerabilityQuery.new(vulnerabilities, {newer: '2017-04-01'}) }
    describe "#all" do
      it { expect(subject.all).to contain_exactly(vuln13,vuln22, vuln23, vuln33) }
    end
    describe "#find_each" do
      it "executes matching vulns" do
        vulns = []
        subject.find_each do |vuln|
          vulns << vuln
        end
        expect(vulns).to contain_exactly(vuln13, vuln22, vuln23, vuln33)
      end
    end
    describe "#include?" do
      it { expect(subject.include?(vuln11)).to be_falsey }
      it { expect(subject.include?(vuln12)).to be_falsey }
      it { expect(subject.include?(vuln13)).to be_truthy }
      it { expect(subject.include?(vuln22)).to be_truthy }
      it { expect(subject.include?(vuln23)).to be_truthy }
      it { expect(subject.include?(vuln33)).to be_truthy }
    end
  end # search :newer

  context "with :older" do
    subject { VulnerabilityQuery.new(vulnerabilities, {older: '2017-02-01'}) }
    describe "#all" do
      it { expect(subject.all).to contain_exactly(vuln11) }
    end
    describe "#find_each" do
      it "executes matching vulns" do
        vulns = []
        subject.find_each do |vuln|
          vulns << vuln
        end
        expect(vulns).to contain_exactly(vuln11)
      end
    end
    describe "#include?" do
      it { expect(subject.include?(vuln11)).to be_truthy }
      it { expect(subject.include?(vuln12)).to be_falsey }
      it { expect(subject.include?(vuln13)).to be_falsey }
      it { expect(subject.include?(vuln22)).to be_falsey }
      it { expect(subject.include?(vuln23)).to be_falsey }
      it { expect(subject.include?(vuln33)).to be_falsey }
    end
  end # search :older

  context "with :lid" do
    subject { VulnerabilityQuery.new(vulnerabilities, {lid: 'PARIS'}) }
    describe "#all" do
      it { expect(subject.all).to contain_exactly(vuln33) }
    end
    describe "#find_each" do
      it "executes matching vulns" do
        vulns = []
        subject.find_each do |vuln|
          vulns << vuln
        end
        expect(vulns).to contain_exactly(vuln33)
      end
    end
    describe "#include?" do
      it { expect(subject.include?(vuln11)).to be_falsey }
      it { expect(subject.include?(vuln12)).to be_falsey }
      it { expect(subject.include?(vuln13)).to be_falsey }
      it { expect(subject.include?(vuln22)).to be_falsey }
      it { expect(subject.include?(vuln23)).to be_falsey }
      it { expect(subject.include?(vuln33)).to be_truthy }
    end
  end # search :lid

  context "with multiple :lid" do
    subject { VulnerabilityQuery.new(vulnerabilities, {lid: 'BER, PARIS'}) }
    describe "#all" do
      it { expect(subject.all).to contain_exactly(vuln11, vuln12, vuln13, vuln33) }
    end
    describe "#find_each" do
      it "executes matching vulns" do
        vulns = []
        subject.find_each do |vuln|
          vulns << vuln
        end
        expect(vulns).to contain_exactly(vuln11, vuln12, vuln13, vuln33)
      end
    end
    describe "#include?" do
      it { expect(subject.include?(vuln11)).to be_truthy }
      it { expect(subject.include?(vuln12)).to be_truthy }
      it { expect(subject.include?(vuln13)).to be_truthy }
      it { expect(subject.include?(vuln22)).to be_falsey }
      it { expect(subject.include?(vuln23)).to be_falsey }
      it { expect(subject.include?(vuln33)).to be_truthy }
    end
  end # search :lid

  describe "#all" do
    context "with search: 'Old'" do
      subject { VulnerabilityQuery.new(vulnerabilities, {search: 'Old'}) }
      it { expect(subject.all).to contain_exactly(vuln12, vuln22, vuln13, vuln23, vuln33) }
    end
    context "with search: 'Server'" do
      subject { VulnerabilityQuery.new(vulnerabilities, {search: 'ServEr'}) }
      it { expect(subject.all).to contain_exactly(vuln33) }
    end
    context "with search: 'other.domain'" do
      subject { VulnerabilityQuery.new(vulnerabilities, {search: 'other.domain'}) }
      it { expect(subject.all).to contain_exactly(vuln33) }
    end
    context "with search: '198.51.100'" do
      subject { VulnerabilityQuery.new(vulnerabilities, {search: '198.51.100'}) }
      it { expect(subject.all).to contain_exactly(vuln11, vuln12, vuln13, vuln22, vuln23) }
    end
    context "with search: '198.51.100.0/26'" do
      subject { VulnerabilityQuery.new(vulnerabilities, {search: '198.51.100.0/26'}) }
      it { expect(subject.all).to contain_exactly(vuln11, vuln12, vuln13) }
    end
    context "with search: #{Date.today.to_s[0,7]}" do
      subject { VulnerabilityQuery.new(vulnerabilities, {search: '2017-04'}) }
      it { expect(subject.all).to contain_exactly(vuln13,vuln22) }
    end
    context "with search: 'linux'" do
      subject { VulnerabilityQuery.new(vulnerabilities, {search: 'ummyO'}) }
      it { expect(subject.all).to contain_exactly(vuln22, vuln23) }
    end
    context "with search: 'PariS'" do
      subject { VulnerabilityQuery.new(vulnerabilities, {search: 'PariS'}) }
      it { expect(subject.all).to contain_exactly(vuln33) }
    end
  end
end
