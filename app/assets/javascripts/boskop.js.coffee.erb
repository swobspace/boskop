# --- GLOBALS

ready = ->
  eol_pivot = ->
    sum = $.pivotUtilities.aggregatorTemplates.sum
    numberFormat = $.pivotUtilities.numberFormat
    intFormat = numberFormat({digitsAfterDecimal: 0})
    $("#eol_pivot").pivot($("#eol_summary"),
      rows: ["Operating System"]
      cols: ["LID"]
      aggregator: sum(intFormat)(["Hosts"])
    )

  if $("#eol_pivot").length > 0
    eol_pivot()
    table = $('#eol_summary').DataTable(
      lengthMenu: [ -1]
      drawCallback: (settings) ->
        eol_pivot()
      dom: "<'row'<'col-md-3'l><'col-md-5'BC><'col-md-4'f>>t<'row'<'col-md-6'ir><'col-md-6'p>>"
      buttons: [
        {
          extend: 'csv',
          sheetName: 'raw',
          filename: 'boskop-eol-matrix',
          title: '',
          exportOptions: {
            selected: false,
            columns: ':visible',
            search: ':applied'
          }
        },
        {
          extend: 'excel',
          sheetName: 'raw',
          filename: 'boskop-eol-matrix',
          title: '',
          exportOptions: {
            selected: false,
            columns: ':visible',
            search: ':applied'
          }
        }
      ]
    )

  vuln_risk_pivot = ->
    sum = $.pivotUtilities.aggregatorTemplates.sum
    numberFormat = $.pivotUtilities.numberFormat
    intFormat = numberFormat({digitsAfterDecimal: 0})
    $("#matrix_pivot").pivot($("#matrix_summary"),
      rows: ["Risk"]
      cols: ["LID"]
      aggregator: sum(intFormat)(["Hosts"])
    )

  if $("#matrix_pivot").length > 0
    vuln_risk_pivot()
    table = $('#matrix_summary').DataTable(
      lengthMenu: [ -1]
      drawCallback: (settings) ->
        vuln_risk_pivot()
      dom: "<'row'<'col-md-3'l><'col-md-5'BC><'col-md-4'f>>t<'row'<'col-md-6'ir><'col-md-6'p>>"
      buttons: [
        {
          extend: 'csv',
          sheetName: 'raw',
          filename: 'boskop-vuln-risk-matrix',
          title: '',
          exportOptions: {
            selected: false,
            columns: ':visible',
            search: ':applied'
          }
        },
        {
          extend: 'excel',
          sheetName: 'raw',
          filename: 'boskop-vuln-risk-matrix',
          title: '',
          exportOptions: {
            selected: false,
            columns: ':visible',
            search: ':applied'
          }
        }
      ]
    )
  $('select#threats').on('change', ->
    if $(this).val() != ""
      $('input[type=checkbox]#critical').prop("checked", false)
  )
  $('input#severity').on('keyup change', ->
    if $(this).val() != ""
      $('input[type=checkbox]#critical').prop("checked", false)
  )
  $('input[type=checkbox]#critical').on('change', ->
    if $(this).prop("checked") == true
      $('select#threats').val([]).trigger("change.select2")
      $('input#severity').val(null).trigger("change")
  )

$(document).on('turbo:load', ready)
