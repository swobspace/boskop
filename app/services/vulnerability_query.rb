##
# Query object mainly for use in vulnerabilities_controller
#
class VulnerabilityQuery
  attr_reader :search_options, :query

  ##
  # possible search options:
  # * :lid - host.location.lid (string or array)
  # * :name - string
  # * :hostname - string
  # * :host_category - host_categories.name (string)
  # * :ip - May be a substring or a cidr address with /mask
  # * :operating_system - string
  # * :plugin_output - string
  # * :threat - string
  # * :severity - string
  # * :lastseen - date (ILIKE)
  # * :created_at - date (ILIKE)
  # * :created_newer - created_at >= :created_newer(date)
  # * :created_older - created_at >= :created_older(date)
  # * :at - date (exact match)
  # * :newer - lastseen >= :newer(date)
  # * :older - lastseen <= :older(date)
  # * :current - shortcut for lastseen >= 1.month.before(Date.today)
  # * :limit - limit result (integer)
  #
  # please note: 
  # left_outer_joins( 
  #   :vulnerability_detail, host: [ :host_category, :operating_system, :location ]
  # )
  # must exist in relation.
  #
  def initialize(relation, search_options = {})
    @relation       = relation
    @search_options = search_options.symbolize_keys!
    @limit          = 0
    @query          ||= build_query
  end

  ##
  # get all matching activities
  def all
    query
  end

  ## 
  # iterate with block 
  def find_each(&block)
    query.find_each(&block)
  end

  ##
  def include?(vuln)
    query.where(id: vuln.id).limit(1).any?
  end

private
  attr_accessor :relation, :limit

  def build_query
    query = relation
    search_string = [] # for global search_option :search
    search_value  = search_options.fetch(:search, false) # for global option :search
    search_options.each do |key,value|
      case key 
      when :limit
        @limit = value.to_i
      when :ip
        query = query.where("hosts.id in (?)", iface_ids(value))
      when :lastseen
        query = query.where("to_char(vulnerabilities.lastseen, 'IYYY-MM-DD') ILIKE ?", "#{value}%")
      when :created_at
        query = query.where("to_char(vulnerabilities.created_at, 'IYYY-MM-DD') ILIKE ?", "#{value}%")
      when :created_newer
        query = query.where("to_char(vulnerabilities.created_at, 'IYYY-MM-DD') >= ?", "#{value}%")
      when :created_older
        query = query.where("to_char(vulnerabilities.created_at, 'IYYY-MM-DD') <= ?", "#{value}%")
      when :at
        query = query.where("vulnerabilities.lastseen = ?", "#{value}")
      when :newer, :since
        query = query.where("vulnerabilities.lastseen >= ?", "#{value}%")
      when :current
        query = query.where("vulnerabilities.lastseen >= ?", 1.month.before(Date.today))
      when :older
        query = query.where("vulnerabilities.lastseen <= ?", "#{value}%")
      when :host_category
        query = query.where("host_categories.name ILIKE ?", "%#{value}%")
      when :operating_system
        query = query.where("operating_systems.name ILIKE ?", "%#{value}%")
      when :hostname
        query = query.where("hosts.name ILIKE ?", "%#{value}%")
      when :name
        query = query.where("vulnerability_details.name ILIKE ?", "%#{value}%")
      when :plugin_output
        query = query.where("vulnerabilities.plugin_output ILIKE ?", "%#{value}%")
      when :severity
        query = query.where("vulnerability_details.severity >= ?", "#{value}")
      when :nvt
        query = query.where("vulnerability_details.nvt ILIKE ?", "%#{value}%")
      when :threat
        query = query.where("vulnerability_details.threat ILIKE ?", "#{value}%")
      when :critical
        query = query.where(vulnerability_details: {threat: ['High', 'Critical'] })
      when :lid
        lids = value.split(%r{[,; |]+})
        query = query.where("locations.lid IN (?)", lids)
      when :search
        search_string << "hosts.id in (:iface_ids)"
        if search_value =~ /\A\d+\.?\d*\z/
          search_string << "vulnerability_details.severity > '#{search_value}'"
        end
        search_string << "to_char(vulnerabilities.lastseen, 'IYYY-MM-DD') ILIKE :search"
        search_string << "operating_systems.name ILIKE :search"
        search_string << "hosts.name ILIKE :search"
        search_string << "host_categories.name ILIKE :search"
        search_string << "vulnerability_details.name ILIKE :search"
        search_string << "vulnerabilities.plugin_output ILIKE :search"
        search_string << "vulnerability_details.threat ILIKE :search"
        search_string << "vulnerability_details.nvt ILIKE :search"
        search_string << "locations.lid ILIKE :search"
      else
        raise ArgumentError, "unknown search option #{key}"
      end
    end
    if search_value
      query = query.where(search_string.join(' or '), search: "%#{search_value}%",
                                                      iface_ids: iface_ids(search_value))
     end
    if limit > 0
      query.limit(limit)
    else
      query
    end
  end

private
  def iface_ids(value)
    if value =~ /\/\d{1,2}\z/
      ids = NetworkInterface.where("network_interfaces.ip <<= ?", value).pluck(:host_id)
    else
      ids = NetworkInterface.where("host(network_interfaces.ip) ILIKE ?", "#{value}%").pluck(:host_id)
    end
  end
end
